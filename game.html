<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Coffee Shop Catch Game</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Arial', sans-serif;
  background: linear-gradient(135deg, #8B4513, #D2691E, #CD853F);
  overflow: hidden;
}

/* NAV BAR */
.nav-bar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: rgba(139, 69, 19, 0.95);
  backdrop-filter: blur(10px);
  padding: 15px 20px;
  z-index: 1000;
  box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
}

.nav-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  max-width: 1200px;
  margin: 0 auto;
}

.nav-title {
  color: #FFF8DC;
  font-size: 24px;
  font-weight: bold;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
}

.nav-link {
  background: #FFF8DC;
  color: #8B4513;
  padding: 10px 20px;
  border-radius: 25px;
  text-decoration: none;
  font-weight: bold;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.nav-link:hover {
  background: #FFE4B5;
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
}

/* GAME CONTAINER */
.game-container {
  position: relative;
  width: 100vw;
  height: 100vh;
  background: linear-gradient(to bottom, #F5F5DC 0%, #FFF8DC 30%, #F0E68C 100%);
  overflow: hidden;
  padding-top: 80px;
  touch-action: none; /* allow custom touch handling for the game */
}

/* AUDIO CONTROLS - MOVED HIGHER */
.audio-controls {
  position: absolute;
  top: 20px;
  left: 20px;
  background: linear-gradient(135deg, #FFF8DC, #FFE4B5);
  padding: 15px;
  border-radius: 15px;
  font-size: 14px;
  color: #8B4513;
  max-width: 250px;
  z-index: 100;
  box-shadow: 0 8px 25px rgba(139, 69, 19, 0.3);
  border: 3px solid #D2691E;
  font-weight: 500;
}

.audio-controls h4 {
  margin-bottom: 10px;
  color: #8B4513;
  font-size: 16px;
}

.audio-control-group {
  margin-bottom: 12px;
}

.audio-control-group label {
  display: block;
  margin-bottom: 5px;
  font-weight: bold;
}

.audio-control-group input[type="checkbox"] {
  margin-right: 8px;
}

.audio-control-group input[type="range"] {
  width: 100%;
  margin-top: 5px;
  accent-color: #8B4513;
}

.audio-status {
  font-size: 12px;
  color: #666;
  font-style: italic;
}

/* BACKGROUND DECORATIONS */
.coffee-shop-bg {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: radial-gradient(circle at 15% 15%, rgba(255, 248, 220, 0.4) 0%, transparent 40%),
              radial-gradient(circle at 85% 85%, rgba(245, 222, 179, 0.4) 0%, transparent 40%),
              linear-gradient(45deg, transparent 20%, rgba(255, 248, 220, 0.2) 50%, transparent 80%);
  z-index: 1;
}

.coffee-shop-decorations {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 2;
  pointer-events: none;
}

.coffee-bean {
  position: absolute;
  width: 30px;
  height: 40px;
  background-image: url('Images/coffeebean.png');
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;
  opacity: 0.2;
  animation: float 8s ease-in-out infinite;
  filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.3));
}
.coffee-bean:nth-child(1) { top: 20%; left: 10%; animation-delay: 0s; }
.coffee-bean:nth-child(2) { top: 40%; right: 15%; animation-delay: 2s; }
.coffee-bean:nth-child(3) { top: 60%; left: 20%; animation-delay: 4s; }
.coffee-bean:nth-child(4) { top: 30%; right: 30%; animation-delay: 6s; }

@keyframes float {
  0%, 100% { transform: translateY(0px) rotate(0deg); }
  50% { transform: translateY(-10px) rotate(5deg); }
}

/* SCORE + HEALTH UI - MOVED HIGHER */
.score {
  position: absolute;
  top: 20px;
  right: 20px;
  background: linear-gradient(135deg, #FFF8DC, #FFE4B5);
  padding: 15px 25px;
  border-radius: 25px;
  font-size: 24px;
  font-weight: bold;
  color: #8B4513;
  box-shadow: 0 8px 25px rgba(139, 69, 19, 0.3);
  border: 3px solid #D2691E;
  z-index: 100;
}

.health-container {
  position: absolute;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(135deg, #FFF8DC, #FFE4B5);
  padding: 12px 20px;
  border-radius: 20px;
  box-shadow: 0 8px 25px rgba(139, 69, 19, 0.3);
  border: 3px solid #D2691E;
  z-index: 100;
  min-width: 200px;
}

.health-label {
  color: #8B4513;
  font-size: 16px;
  font-weight: bold;
  margin-bottom: 8px;
  text-align: center;
}

.health-bar {
  width: 100%;
  height: 20px;
  background-color: #ddd;
  border-radius: 10px;
  overflow: hidden;
  border: 2px solid #8B4513;
  position: relative;
}

.health-fill {
  height: 100%;
  background: linear-gradient(90deg, #ff4444 0%, #ffaa44 50%, #44ff44 100%);
  border-radius: 8px;
  transition: width 0.3s ease;
  position: relative;
}

.health-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: #8B4513;
  font-weight: bold;
  font-size: 12px;
  text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
}

/* LEVEL PROGRESS METER - POSITIONED BELOW SCORE WITH GAP */
.level-progress-container {
  position: absolute;
  top: 105px;
  right: 20px;
  background: linear-gradient(135deg, #FFF8DC, #FFE4B5);
  padding: 12px 20px;
  border-radius: 20px;
  box-shadow: 0 8px 25px rgba(139, 69, 19, 0.3);
  border: 3px solid #D2691E;
  z-index: 100;
  min-width: 280px;
}

    /* Credit box styling: match other UI boxes in the game */
    #credit-under {
      background: linear-gradient(135deg, #FFF8DC, #FFE4B5);
      padding: 10px 14px;
      border-radius: 14px;
      box-shadow: 0 8px 25px rgba(139, 69, 19, 0.3);
      border: 3px solid #D2691E;
      color: #8B4513;
      font-weight: 500;
      font-size: 0.95rem;
      text-align: center;
      z-index: 100; /* match other UI panels so falling items (z-index:110) render in front */
      pointer-events: none; /* avoid intercepting touches */
      display: inline-block;
    }

    /* ensure the inner paragraph doesn't use a separate white background */
    #credit-under p { background: transparent; margin: 0; color: inherit; font: inherit; }

.level-progress-label {
  color: #8B4513;
  font-size: 14px;
  font-weight: bold;
  margin-bottom: 8px;
  text-align: center;
}

.level-progress-bar {
  width: 100%;
  height: 16px;
  background-color: #ddd;
  border-radius: 8px;
  overflow: hidden;
  border: 2px solid #8B4513;
  position: relative;
}

.level-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #44ff44 0%, #88ff88 100%);
  border-radius: 6px;
  transition: width 0.3s ease;
  position: relative;
}

.level-progress-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: #8B4513;
  font-weight: bold;
  font-size: 12px;
  text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
}

/* LEVEL INDICATOR - LOWERED MUCH MORE */
.level-indicator {
  position: absolute;
  top: 140px;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(135deg, #FFF8DC, #FFE4B5);
  padding: 10px 20px;
  border-radius: 20px;
  font-size: 18px;
  font-weight: bold;
  color: #8B4513;
  z-index: 100;
  box-shadow: 0 8px 25px rgba(139, 69, 19, 0.3);
  border: 3px solid #D2691E;
}

/* INSTRUCTIONS - MOVED UP */
.instructions {
  position: absolute;
  top: 340px;
  left: 20px;
  background: linear-gradient(135deg, #FFF8DC, #FFE4B5);
  padding: 20px;
  border-radius: 20px;
  font-size: 16px;
  color: #8B4513;
  max-width: 320px;
  z-index: 100;
  box-shadow: 0 8px 25px rgba(139, 69, 19, 0.3);
  border: 3px solid #D2691E;
  font-weight: 500;
}

/* PIXEL MUG DESIGN - FIXED POSITIONING */
.mug {
  position: absolute;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%);
  width: 100px;
  height: 80px;
  background-image: url('Images/pixelmug.png');
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;
  z-index: 10;
  transition: none;
  filter: drop-shadow(0 8px 20px rgba(0, 0, 0, 0.3));
}


/* FALLING ITEMS */
.falling-item {
  position: absolute;
  width: 45px;
  height: 45px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  z-index: 110;
  filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.4));
  transition: transform 0.1s ease;
}

.good-item {
  background: linear-gradient(135deg, #FFB6C1, #FFA0B4);
  box-shadow: 
    0 4px 15px rgba(255, 182, 193, 0.5),
    inset 0 1px 3px rgba(255, 255, 255, 0.4);
  border: 2px solid #FF69B4;
  animation: gentleBounce 1.5s ease-in-out infinite;
}

.bad-item {
  background: linear-gradient(135deg, #8B4513, #654321);
  box-shadow: 
    0 4px 15px rgba(139, 69, 19, 0.5),
    inset 0 1px 3px rgba(0, 0, 0, 0.4);
  border: 2px solid #4A2C2A;
  animation: gentleWiggle 0.8s ease-in-out infinite;
}

@keyframes gentleBounce {
  0%, 100% { transform: translateY(0px) scale(1); }
  50% { transform: translateY(-3px) scale(1.02); }
}

@keyframes gentleWiggle {
  0%, 100% { transform: rotate(0deg) scale(1); }
  25% { transform: rotate(1deg) scale(1.01); }
  75% { transform: rotate(-1deg) scale(1.01); }
}

/* PARTICLES */
.particle {
  position: absolute;
  width: 6px;
  height: 6px;
  background: #FFD700;
  border-radius: 50%;
  pointer-events: none;
  animation: particle 0.6s ease-out forwards;
}

@keyframes particle {
  0% {
    opacity: 1;
    transform: scale(1);
  }
  100% {
    opacity: 0;
    transform: scale(0) translateY(-50px);
  }
}

/* GAME OVER SCREEN */
.game-over {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(255, 255, 255, 0.95);
  padding: 40px;
  border-radius: 20px;
  text-align: center;
  font-size: 24px;
  color: #8B4513;
  display: none;
  z-index: 200;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.restart-btn {
  background: #8B4513;
  color: white;
  border: none;
  padding: 15px 30px;
  border-radius: 25px;
  font-size: 18px;
  cursor: pointer;
  margin-top: 20px;
  transition: all 0.3s ease;
}

.restart-btn:hover {
  background: #A0522D;
  transform: scale(1.05);
}

/* Standard navbar hover effects */
nav a::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: #d2b48c;
  border-radius: 20px;
  opacity: 0;
  transform: scale(0.8);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  z-index: -1;
}

nav a:hover {
  color: #e8f5e8;
}

nav a:hover::before {
  opacity: 1;
  transform: scale(1);
}

/* AUDIO ELEMENTS - HIDDEN */
audio {
  display: none;
}
    
    /* --- Mobile adjustments: reduce clumping and ensure credit is visible --- */
    @media (max-width: 520px) {
      /* push top UI down slightly and reduce sizes */
      .audio-controls { top: 88px; left: 8px; max-width: 180px; font-size: 13px; }
      .instructions { position: fixed; top: 200px; left: 8px; max-width: calc(100% - 16px); z-index: 220; }
      .level-indicator { top: 92px; font-size: 16px; padding: 8px 14px; }
      .score { top: 18px; right: 8px; font-size: 18px; padding: 8px 14px; }
      .health-container { top: 52px; left: 8px; transform: none; min-width: 140px; }
      .level-progress-container { top: 130px; right: 8px; min-width: 160px; }
      .mug { bottom: 140px; width: 80px; height: 64px; }
      .game-container { padding-top: 100px; }

      /* Make the credit pill fixed and visible above other UI on phones */
      .credit-pill, .credit-under { position: fixed !important; left: 12px !important; right: 12px !important; bottom: calc(12px + env(safe-area-inset-bottom)); z-index: 100 !important; display: block !important; pointer-events: none; text-align: center; }
      .credit-pill p, .credit-under p { margin: 0; display: inline-block; background: transparent; padding: 8px 12px; border-radius: 10px; color: #5d6e56; font-size: 0.95rem; }
    }
</style>
</head>
<body>
  <!-- Standard Navigation Bar -->
  <nav style="display: flex; justify-content: center; gap: 2rem; padding: 1.2rem; background: rgba(232, 245, 232, 0.95); backdrop-filter: blur(12px); position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid #bdc5a5; box-shadow: 0 2px 15px rgba(45,48,33,0.1); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);">
    <a href="index.html" style="text-decoration: none; color: #2d3021; font-weight: 600; letter-spacing: 0.5px; position: relative; padding: 0.5rem 1rem; border-radius: 20px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);">Home</a>
    <a href="hobbies.html" style="text-decoration: none; color: #2d3021; font-weight: 600; letter-spacing: 0.5px; position: relative; padding: 0.5rem 1rem; border-radius: 20px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);">Hobbies</a>
    <a href="duluth.html" style="text-decoration: none; color: #2d3021; font-weight: 600; letter-spacing: 0.5px; position: relative; padding: 0.5rem 1rem; border-radius: 20px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);">Discover Duluth</a>
    <a href="resume.html" style="text-decoration: none; color: #2d3021; font-weight: 600; letter-spacing: 0.5px; position: relative; padding: 0.5rem 1rem; border-radius: 20px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);">Resume</a>
    <a href="career.html" style="text-decoration: none; color: #2d3021; font-weight: 600; letter-spacing: 0.5px; position: relative; padding: 0.5rem 1rem; border-radius: 20px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);">Career Interests</a>
    <a href="game.html" style="text-decoration: none; color: #f0ead8; font-weight: 600; letter-spacing: 0.5px; position: relative; padding: 0.5rem 1rem; border-radius: 20px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); background: #d2b48c;">Game</a>
  </nav>

  <div class="nav-bar">
    <div class="nav-content">
      <div class="nav-title">‚òï Coffee Shop Catch</div>
      <a href="index.html" class="nav-link">üè† Back to Home</a>
    </div>
  </div>

  <div class="game-container">
    <div class="coffee-shop-bg"></div>
    <div class="coffee-shop-decorations">
      <div class="coffee-bean"></div>
      <div class="coffee-bean"></div>
      <div class="coffee-bean"></div>
      <div class="coffee-bean"></div>
    </div>

    <!-- AUDIO CONTROLS -->
    <div class="audio-controls">
      <h4>üéµ Audio Controls</h4>
      <div class="audio-control-group">
        <label>
          <input type="checkbox" id="musicToggle" checked>
          Background Music
        </label>
        <div class="audio-status" id="musicStatus">Music starts at first click</div>
      </div>
      <div class="audio-control-group">
        <label>Music Volume:</label>
        <input type="range" id="musicVolume" min="0" max="100" value="30">
      </div>
      <div class="audio-control-group">
        <label>
          <input type="checkbox" id="soundToggle" checked>
          Sound Effects
        </label>
      </div>
      <div class="audio-control-group">
        <label>Sound Volume:</label>
        <input type="range" id="soundVolume" min="0" max="100" value="70">
      </div>
    </div>

    <div class="instructions">
      <strong>üç© Catch the Donuts!</strong><br>
      Move your mouse to catch delicious donuts!<br>
      Avoid the flies (brown) ü™∞<br>
      Catch the donuts (pink) üç©
    </div>

    <div class="level-indicator" id="levelIndicator">Level 1</div>
    <div class="score" id="score">Score: 0</div>

    <div class="health-container">
      <div class="health-label">‚ù§Ô∏è Health</div>
      <div class="health-bar">
        <div class="health-fill" id="healthFill" style="width: 100%;"></div>
        <div class="health-text" id="healthText">100/100</div>
      </div>
    </div>

    <!-- LEVEL PROGRESS METER -->
    <div class="level-progress-container">
      <div class="level-progress-label">üìä Level Progress</div>
      <div class="level-progress-bar">
        <div class="level-progress-fill" id="levelProgressFill" style="width: 0%;"></div>
        <div class="level-progress-text" id="levelProgressText">0/50 to Level 2</div>
      </div>
    </div>

    <!-- Attribution: placed under the level progress container for visibility -->
    <div id="credit-under" class="credit-under" style="position:absolute;pointer-events:none;z-index: index 100;;right:20px;text-align:center;">
      <p>With thanks to Kirsten Prinsen and Emily Marciniak for their help creating this game.</p>
    </div>

     <!-- PIXEL MUG DESIGN -->
     <div class="mug" id="mug"></div>
     <div class="steam-line"></div>
     <div class="steam-line"></div>
     <div class="steam-line"></div>
     
     <!-- GAME OVER SCREEN -->
     <div class="game-over" id="gameOver">
       <h2>Game Over!</h2>
       <p>Final Score: <span id="finalScore">0</span></p>
       <button class="restart-btn" onclick="restartGame()">Play Again</button>
     </div>
     
    
  </div>

  <!-- AUDIO ELEMENTS -->
  <audio id="backgroundMusic" loop>
    <source src="audio/background.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>
  
  <audio id="pointsSound">
    <source src="audio/points.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>
  
  <audio id="levelupSound">
    <source src="audio/levelup.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>
  
  <audio id="badSound">
    <source src="audio/bad.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>
  
  <audio id="failSound">
    <source src="audio/fail.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>

  <script>
    class CoffeeShopGame {
      constructor() {
        this.canvas = document.querySelector('.game-container');
        this.mug = document.getElementById('mug');
        this.scoreElement = document.getElementById('score');
        this.gameOverElement = document.getElementById('gameOver');
        this.finalScoreElement = document.getElementById('finalScore');
        this.levelIndicator = document.getElementById('levelIndicator');
        this.healthFill = document.getElementById('healthFill');
        this.healthText = document.getElementById('healthText');
        
        // Level progress elements
        this.levelProgressFill = document.getElementById('levelProgressFill');
        this.levelProgressText = document.getElementById('levelProgressText');
        
        // Audio elements
        this.backgroundMusic = document.getElementById('backgroundMusic');
        this.pointsSound = document.getElementById('pointsSound');
        this.levelupSound = document.getElementById('levelupSound');
        this.badSound = document.getElementById('badSound');
        this.failSound = document.getElementById('failSound');
        
        // Audio control elements
        this.musicToggle = document.getElementById('musicToggle');
        this.musicVolume = document.getElementById('musicVolume');
        this.soundToggle = document.getElementById('soundToggle');
        this.soundVolume = document.getElementById('soundVolume');
        this.musicStatus = document.getElementById('musicStatus');
        
        // Audio state
        this.musicEnabled = true;
        this.soundEnabled = true;
        this.backgroundMusicStarted = false;
        this.userInteracted = false;
        
        // Set initial volumes
        this.backgroundMusic.volume = 0.3;
        this.pointsSound.volume = 0.7;
        this.levelupSound.volume = 0.8;
        this.badSound.volume = 0.6;
        this.failSound.volume = 0.8;
        
        this.score = 0;
        this.level = 1;
        this.health = 100;
        this.maxHealth = 100;
        this.gameRunning = false;
        this.fallingItems = [];
        this.spawnRate = 3000; // milliseconds
        this.fallSpeed = 1.5; // pixels per frame
        this.badItemChance = 0.15; // 15% chance for bad items
        
        this.goodItems = ['üç©', 'üç©', 'üç©', 'üç©', 'üç©', 'üç©', 'üç©', 'üç©']; // All donuts!
        this.badItems = ['ü™∞', 'ü™∞', 'ü™∞', 'ü™∞', 'ü™∞', 'ü™∞', 'ü™∞', 'ü™∞']; // All flies!
        
        this.init();
      }
      
      init() {
        this.setupEventListeners();
        this.setupAudioControls();
        this.startGame();
      }
      
      setupAudioControls() {
        // Music toggle - FIXED to restart music when re-enabled
        this.musicToggle.addEventListener('change', () => {
          this.musicEnabled = this.musicToggle.checked;
          if (!this.musicEnabled) {
            this.backgroundMusic.pause();
            this.backgroundMusicStarted = false;
            this.musicStatus.textContent = 'Music disabled';
          } else {
            this.musicStatus.textContent = 'Music enabled';
            // Start music immediately when re-enabled
            if (this.userInteracted) {
              this.playBackgroundMusic();
            }
          }
        });
        
        // Music volume
        this.musicVolume.addEventListener('input', () => {
          const volume = this.musicVolume.value / 100;
          this.backgroundMusic.volume = volume;
        });
        
        // Sound toggle
        this.soundToggle.addEventListener('change', () => {
          this.soundEnabled = this.soundToggle.checked;
        });
        
        // Sound volume
        this.soundVolume.addEventListener('input', () => {
          const volume = this.soundVolume.value / 100;
          this.pointsSound.volume = volume;
          this.levelupSound.volume = volume;
          this.badSound.volume = volume;
          this.failSound.volume = volume;
        });
      }
      
      setupEventListeners() {
        // Unified pointer/touch/mouse handling for mug movement
        const mugWidth = 100;
        const handlePointerX = (clientX) => {
          if (!this.gameRunning) return;
          const containerRect = this.canvas.getBoundingClientRect();
          const pointerX = clientX - containerRect.left;
          const maxX = containerRect.width - mugWidth;
          let newX = pointerX - mugWidth / 2;
          newX = Math.max(0, Math.min(newX, maxX));
          this.mug.style.left = newX + 'px';
        };

        // Pointer events (recommended): covers mouse, touch, and stylus in one API
        this.canvas.addEventListener('pointermove', (e) => {
          handlePointerX(e.clientX);
        });

        // Pointer down to capture first user interaction for audio
        this.canvas.addEventListener('pointerdown', (e) => {
          this.userInteracted = true;
          this.playBackgroundMusic();
        });

        // Fallback touch handlers for older browsers and to prevent scrolling while dragging
        this.canvas.addEventListener('touchstart', (e) => {
          this.userInteracted = true;
          this.playBackgroundMusic();
          if (e.touches && e.touches[0]) {
            handlePointerX(e.touches[0].clientX);
          }
        }, { passive: false });

        this.canvas.addEventListener('touchmove', (e) => {
          // prevent scroll while playing the game
          e.preventDefault();
          if (e.touches && e.touches[0]) {
            handlePointerX(e.touches[0].clientX);
          }
        }, { passive: false });

        // Play background music on first non-canvas click/keyboard too
        document.addEventListener('click', () => {
          this.userInteracted = true;
          this.playBackgroundMusic();
        }, { once: true });

        document.addEventListener('keydown', () => {
          this.userInteracted = true;
          this.playBackgroundMusic();
        }, { once: true });
      }
      
      playBackgroundMusic() {
        if (this.musicEnabled && !this.backgroundMusicStarted) {
          try {
            this.backgroundMusic.play().then(() => {
              this.backgroundMusicStarted = true;
              this.musicStatus.textContent = 'üéµ Music playing';
            }).catch(e => {
              console.log('Background music autoplay was prevented:', e);
              this.musicStatus.textContent = 'Click to enable music';
            });
          } catch(e) {
            console.log('Error playing background music:', e);
          }
        } else if (this.musicEnabled && this.backgroundMusicStarted && this.backgroundMusic.paused) {
          // This handles the case where music was disabled and then re-enabled
          try {
            this.backgroundMusic.play().then(() => {
              this.musicStatus.textContent = 'üéµ Music playing';
            }).catch(e => {
              console.log('Background music restart failed:', e);
              this.musicStatus.textContent = 'Click to enable music';
            });
          } catch(e) {
            console.log('Error restarting background music:', e);
          }
        }
      }
      
      playSound(soundElement) {
        if (!this.soundEnabled) return;
        
        try {
          soundElement.currentTime = 0;
          soundElement.play().catch(e => {
            console.log('Sound play failed:', e);
          });
        } catch(e) {
          console.log('Error playing sound:', e);
        }
      }
      
      startGame() {
        this.gameRunning = true;
        this.score = 0;
        this.level = 1;
        this.health = this.maxHealth;
        this.spawnRate = 3000;
        this.fallSpeed = 1.5;
        this.badItemChance = 0.15;
        this.fallingItems = [];
        
        this.updateScore();
        this.updateLevel();
        this.updateHealth();
        this.updateLevelProgress();
        this.gameOverElement.style.display = 'none';
        
        this.playBackgroundMusic();
        this.spawnItems();
        this.gameLoop();
      }
      
      spawnItems() {
        if (!this.gameRunning) return;
        
        const isBad = Math.random() < this.badItemChance;
        const items = isBad ? this.badItems : this.goodItems;
        const item = items[Math.floor(Math.random() * items.length)];
        
        const fallingItem = document.createElement('div');
        fallingItem.className = `falling-item ${isBad ? 'bad-item' : 'good-item'}`;
        fallingItem.textContent = item;
        fallingItem.style.left = Math.random() * (window.innerWidth - 50) + 'px';
        fallingItem.style.top = '-50px';
        
        this.canvas.appendChild(fallingItem);
        this.fallingItems.push({
          element: fallingItem,
          isBad: isBad,
          x: parseInt(fallingItem.style.left),
          y: -50,
          speed: this.fallSpeed + Math.random() * 1
        });
        
        setTimeout(() => this.spawnItems(), this.spawnRate);
      }
      
      gameLoop() {
        if (!this.gameRunning) return;
        
        this.updateFallingItems();
        this.checkCollisions();
        this.updateLevel();
        this.updateLevelProgress();
        
        requestAnimationFrame(() => this.gameLoop());
      }
      
      updateFallingItems() {
        this.fallingItems.forEach((item, index) => {
          item.y += item.speed;
          item.element.style.top = item.y + 'px';
          
          // Remove items that fall off screen
          if (item.y > window.innerHeight + 50) {
            if (!item.isBad) {
              // Missed a donut - lose health and play bad sound
              this.decreaseHealth(15);
              this.playSound(this.badSound);
            }
            
            if (item.element.parentNode) {
              item.element.parentNode.removeChild(item.element);
            }
            this.fallingItems.splice(index, 1);
          }
        });
      }
      
      checkCollisions() {
        const mugRect = this.mug.getBoundingClientRect();
        
        this.fallingItems.forEach((item, index) => {
          const itemRect = item.element.getBoundingClientRect();
          
          // Check collision between mug and item
          if (itemRect.bottom >= mugRect.top && 
              itemRect.top <= mugRect.bottom &&
              itemRect.left < mugRect.right && 
              itemRect.right > mugRect.left) {
            
            if (item.isBad) {
              // Caught a fly - lose health and play bad sound
              this.decreaseHealth(20);
              this.playSound(this.badSound);
              this.createParticles(itemRect.left + 25, itemRect.top + 25, '#FF6B6B');
            } else {
              // Caught a donut - gain points and play points sound
              this.score += 10;
              this.playSound(this.pointsSound);
              this.createParticles(itemRect.left + 25, itemRect.top + 25, '#FFB6C1');
            }
            
            // Remove item
            if (item.element.parentNode) {
              item.element.parentNode.removeChild(item.element);
            }
            this.fallingItems.splice(index, 1);
            
            this.updateScore();
            this.updateLevelProgress();
          }
        });
      }
      
      createParticles(x, y, color) {
        for (let i = 0; i < 8; i++) {
          const particle = document.createElement('div');
          particle.className = 'particle';
          particle.style.left = x + 'px';
          particle.style.top = y + 'px';
          particle.style.background = color;
          
          this.canvas.appendChild(particle);
          
          setTimeout(() => {
            if (particle.parentNode) {
              particle.parentNode.removeChild(particle);
            }
          }, 600);
        }
      }
      
      updateScore() {
        this.scoreElement.textContent = `Score: ${this.score}`;
      }
      
      updateHealth() {
        const healthPercentage = (this.health / this.maxHealth) * 100;
        this.healthFill.style.width = healthPercentage + '%';
        this.healthText.textContent = `${this.health}/${this.maxHealth}`;
        
        // Change health bar color based on health level
        if (healthPercentage > 60) {
          this.healthFill.style.background = 'linear-gradient(90deg, #44ff44 0%, #88ff88 100%)';
        } else if (healthPercentage > 30) {
          this.healthFill.style.background = 'linear-gradient(90deg, #ffaa44 0%, #ffcc66 100%)';
        } else {
          this.healthFill.style.background = 'linear-gradient(90deg, #ff4444 0%, #ff6666 100%)';
        }
      }
      
      decreaseHealth(amount) {
        this.health = Math.max(0, this.health - amount);
        this.updateHealth();
        
        // Add visual feedback for health loss
        this.healthFill.style.transform = 'scale(1.05)';
        setTimeout(() => {
          this.healthFill.style.transform = 'scale(1)';
        }, 200);
        
        // Check if game should end
        if (this.health <= 0) {
          this.gameOver();
        }
      }
      
      updateLevel() {
        const newLevel = Math.floor(this.score / 50) + 1;
        if (newLevel > this.level) {
          this.level = newLevel;
          this.levelIndicator.textContent = `Level ${this.level}`;
          
          // Play level up sound
          this.playSound(this.levelupSound);
          
          // Increase difficulty more gradually
          this.spawnRate = Math.max(1500, this.spawnRate - 150);
          this.fallSpeed = Math.min(4, this.fallSpeed + 0.4);
          this.badItemChance = Math.min(0.4, this.badItemChance + 0.03);
        }
      }
      
      updateLevelProgress() {
        // Calculate progress to next level
        const currentLevelScore = (this.level - 1) * 50; // Score at current level start
        const nextLevelScore = this.level * 50; // Score needed for next level
        const progress = this.score - currentLevelScore;
        const progressToNext = nextLevelScore - currentLevelScore; // Always 50
        const progressPercentage = (progress / progressToNext) * 100;
        
        // Update the progress bar
        this.levelProgressFill.style.width = Math.min(100, Math.max(0, progressPercentage)) + '%';
        
        // Update the text
        const nextLevel = this.level + 1;
        const remaining = progressToNext - progress;
        this.levelProgressText.textContent = `${progress}/${progressToNext} to Level ${nextLevel}`;
        
        // Change color based on progress (gold when close to next level)
        if (progressPercentage > 80) {
          this.levelProgressFill.style.background = 'linear-gradient(90deg, #FFD700 0%, #FFA500 100%)';
        } else {
          this.levelProgressFill.style.background = 'linear-gradient(90deg, #44ff44 0%, #88ff88 100%)';
        }
      }
      
      gameOver() {
        this.gameRunning = false;
        this.finalScoreElement.textContent = this.score;
        this.gameOverElement.style.display = 'block';
        
        // Stop background music and play fail sound
        this.backgroundMusic.pause();
        this.backgroundMusic.currentTime = 0;
        this.playSound(this.failSound);
        
        // Clear all falling items
        this.fallingItems.forEach(item => {
          if (item.element.parentNode) {
            item.element.parentNode.removeChild(item.element);
          }
        });
        this.fallingItems = [];
      }
    }
    
    // Initialize game
    let game;
    
    function restartGame() {
      if (game) {
        game.startGame();
      } else {
        game = new CoffeeShopGame();
      }
    }
    
    // Start the game when page loads
    window.addEventListener('load', () => {
      game = new CoffeeShopGame();
    });
    
    // Position the credit under the level progress container so it's visible
    (function(){
      const credit = document.getElementById('credit-under');
      const container = document.querySelector('.game-container');
      const prog = document.querySelector('.level-progress-container');
      if (!credit || !container || !prog) return;

      function placeCredit(){
        const progRect = prog.getBoundingClientRect();
        const containerRect = container.getBoundingClientRect();
        // calculate position relative to the container
        const top = progRect.bottom - containerRect.top + 8; // 8px gap
        const right = containerRect.right - progRect.right + 20; // keep 20px right padding
        credit.style.top = top + 'px';
        // make width similar to progress box for neat alignment
        const width = progRect.width;
        credit.style.width = width + 'px';
        credit.style.left = (progRect.left - containerRect.left) + 'px';
      }

      // initial placement and on resize/scroll
      window.addEventListener('load', placeCredit);
      window.addEventListener('resize', placeCredit);
      window.addEventListener('scroll', placeCredit);
      // call immediately
      placeCredit();
    })();
  </script>
</body>
</html>
